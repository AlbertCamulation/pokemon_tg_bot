name: Fetch and Commit PvPoke Rankings

on:
  schedule:
    # æ¯å¤©åŸ·è¡Œä¸€æ¬¡ (at 00:00 UTC)
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest

    # åŸºæœ¬æ¬Šé™è¨­å®š
    permissions:
      contents: read
      pull-requests: write

    steps:
      # æ­¥é©Ÿ 1: å…ˆ Checkout ä½ çš„å°ˆæ¡ˆç¨‹å¼ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥é©Ÿ 3: å®‰è£ Python ä¾è³´å¥—ä»¶
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # æ­¥é©Ÿ 4: åŸ·è¡Œ Python è…³æœ¬ä¾†ç²å–è³‡æ–™
      - name: Fetch PvPoke rankings data
        run: python scripts/fetch_data.py

      # â˜…â˜…â˜… æ­¥é©Ÿ 5: æ‹”é™¤åŸæœ¬çš„ git pushï¼Œæ”¹ç‚ºè‡ªå‹•å»ºç«‹ PR â˜…â˜…â˜…
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }} # ä½¿ç”¨ä½ ä¹‹å‰è¨­å®šçš„è¬èƒ½é‘°åŒ™
          commit-message: 'auto: Update PvPoke rankings data'
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: bot-update-rankings # æ©Ÿå™¨äººå°ˆç”¨åˆ†æ”¯
          base: main
          delete-branch: true
          title: 'ğŸ¤– è‡ªå‹•æ›´æ–°: PvPoke æ’åæ•¸æ“š'
          body: |
            æ›´æ–° data/ è³‡æ–™å¤¾ä¸‹çš„æ’åè³‡æ–™
            - åŸ·è¡Œè€…: GitHub Actions
          add-paths: |
            data/

      # â˜…â˜…â˜… æ­¥é©Ÿ 6: åˆ©ç”¨ Admin ç‰¹æ¬Šç›´æ¥è‡ªå‹•åˆä½µ â˜…â˜…â˜…
      - name: Auto Merge
        if: steps.cpr.outputs.pull-request-number != ''
        run: gh pr merge --squash --delete-branch "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
